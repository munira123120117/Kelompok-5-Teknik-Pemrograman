import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy.interpolate import griddata
import rasterio
from rasterio.transform import from_origin
from matplotlib import cm
st.set_page_config(page_title="Pemetaan Gravity", layout="wide")
st.title("Aplikasi Desain Pemetaan Gravity!")
st.markdown("Masukan data pada sidebar untuk membuat peta kontur")
# Mencoba me-rename kolom umum ke nama standar: X, Y, value
    rename_try = {}
    for c in df.columns:
        lc = c.lower()
        if lc in ["x", "easting", "lon", "longitude"]:
            rename_try[c] = "X"
        elif lc in ["y", "northing", "lat", "latitude"]:
            rename_try[c] = "Y"
        # Kolom Nilai/Anomali
        elif lc in ["z", "val", "value", "anomali", "anomaly", "gravity", "bouguer", "mgal"]:
            rename_try[c] = "value"
    df = df.rename(columns=rename_try)
# Memeriksa kolom wajib
    missing = [c for c in REQUIRED_COLS if c not in df.columns]
    if missing:
        raise ValueError(f"Kolom wajib belum lengkap. Harus ada: {REQUIRED_COLS}. Missing: {missing}")

    df = df[REQUIRED_COLS].copy()
    df = df.dropna()

    # Memastikan data numerik
    for c in REQUIRED_COLS:
        df[c] = pd.to_numeric(df[c], errors="coerce")
    df = df.dropna()

    if len(df) < 5:
        raise ValueError("Data terlalu sedikit setelah dibersihkan. Minimal ~5 titik.")

    return df

def make_grid(df: pd.DataFrame, nx: int, ny: int):
    x = df["X"].to_numpy()
    y = df["Y"].to_numpy()
    v = df["value"].to_numpy()

    xi = np.linspace(x.min(), x.max(), nx)
    yi = np.linspace(y.min(), y.max(), ny)
    Xg, Yg = np.meshgrid(xi, yi)
    return x, y, v, Xg, Yg

def interpolate_grid(x, y, v, Xg, Yg, method: str):
    Zg = griddata(points=(x, y), values=v, xi=(Xg, Yg), method=method)
    return Zg

def fill_nans_nearest(x, y, v, Xg, Yg, Zg):
    # Jika interpolasi membuat lubang (NaN), isi dengan nearest
    if np.isnan(Zg).any():
        Z_near = griddata((x, y), v, (Xg, Yg), method="nearest")
        Zg = np.where(np.isnan(Zg), Z_near, Zg)
    return Zg
# ---------- Sidebar controls ----------
st.sidebar.header("Pengaturan Pemetaan Gravitasi")
uploaded = st.sidebar.file_uploader("Upload CSV (Kolom X, Y, Anomali Bouguer)", type=["csv"])
st.sidebar.caption("Pastikan kolom 'value' berisi Anomali Bouguer (mGal).")
unit_label = "mGal"
st.sidebar.subheader("Pengaturan Grid & Interpolasi")
method = st.sidebar.selectbox("Metode interpolasi", ["linear", "cubic", "nearest"], index=0)
nx = st.sidebar.slider("Resolusi grid (X)", 50, 400, 200, step=25)
ny = st.sidebar.slider("Resolusi grid (Y)", 50, 400, 200, step=25)
fill_holes = st.sidebar.checkbox("Isi lubang (NaN) pakai nearest", value=True)
st.sidebar.subheader("Pengaturan Visualisasi")
show_scatter = st.sidebar.checkbox("Tampilkan titik data di atas peta", value=True)
show_contours = st.sidebar.checkbox("Tampilkan garis kontur", value=True)
n_contours = st.sidebar.slider("Jumlah kontur", 5, 40, 15, step=1)
# ---------- Main Execution ----------
if uploaded is None:
    st.info("Upload file CSV data gravitasi (Anomali Bouguer) untuk memulai pemetaan.")
    st.stop()
try:
    # Membaca file CSV yang diunggah
    df_raw = pd.read_csv(uploaded)
    # Memvalidasi dan membersihkan data
    df = validate_df(df_raw)
    st.success("Data berhasil diunggah dan divalidasi!") 
except Exception as e:
    st.error(f"Gagal membaca/validasi data: {e}")
    st.stop()
